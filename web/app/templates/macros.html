{# Macros for rendering form controls. #}
{% macro form_field(elem, prepend='') -%}
    <div class="form-group">
        {{ elem.label }}
        <div class="input-group">
            {%- if prepend -%}
                <div class="input-group-prepend">
                    <span class="input-group-text">{{ prepend }}</span>
                </div>
            {%- endif %}
            {%- if elem.errors -%}
                {{ elem(class_='form-control is-invalid', **kwargs) }}
            {%- else -%}
                {{ elem(class_='form-control', **kwargs) }}
            {%- endif -%}
            <div class="invalid-feedback">
                {% for error in elem.errors %}{{ error }}{% endfor %}
            </div>
        </div>
    </div>
{%- endmacro %}

{% macro form_check(elem) -%}
    <div class="input-group">
        {% if elem.errors %}
            <div class="form-check">{{ elem(class_='form-check-input is-invalid', **kwargs) }}{{ elem.label }}</div>
        {% else %}
            <div class="form-check">{{ elem(class_='form-check-input', **kwargs) }}{{ elem.label }}</div>
        {% endif %}
        <div class="invalid-feedback">
            {% for error in elem.errors %}{{ error }}{% endfor %}
        </div>
    </div>
{%- endmacro %}

{% macro form_submit(elem) -%}
    {{ elem(class_='btn btn-primary', **kwargs) }}
{%- endmacro %}

{% macro form_tags(elem) -%}
    {% do kwargs.update({'data-role': 'tagsinput'}) %}
    {{ form_field(elem, **kwargs) }}
{% endmacro %}


{# Renders pagination buttons for a pagination object and an endpoint. #}
{% macro show_pages(pagination, base_url) %}
<ul class="pagination">
    {% if pagination.has_prev %}
    <li class="page-item"><a class="page-link" href="{{ set_page_number(base_url, pagination.prev_num) }}">Previous</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for page in pagination.iter_pages() %}
    <li class="page-item {% if page == pagination.page %}active{% endif %}"><a class="page-link" href="{{ set_page_number(base_url, page) }}">{{ page }}</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">...</span></li>
    {% endfor %}

    {% if pagination.has_next %}
    <li class="page-item"><a class="page-link" href="{{ set_page_number(base_url, pagination.next_num) }}">Next</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
</ul>
{% endmacro %}


{# Loads a form into a modal using jQuery. Must be placed in the $(document).ready() handler. #}
{% macro dynamic_form(button_id, modal_id, form_endpoint, form_id, submit_id) %}
$('#' + '{{ button_id }}').click(function() {
    $.get('{{ form_endpoint }}', function(data) {
        $('#' + '{{ modal_id }}' + ' .modal-content').html(data);
        $('#' + '{{ modal_id }}' + ' .modal-content input[data-role=tagsinput], select[multiple][data-role=tagsinput]').tagsinput();
        $('#' + '{{ modal_id }}').modal('show')

        $('#' + '{{ submit_id }}').click(function(event) {
            event.preventDefault();
            $.post('{{ form_endpoint }}', data=$('#' + '{{ form_id }}').serialize(), function(data) {
                if (data.status == 'ok') {
                    $('#' + '{{ modal_id }}').modal('hide');
                    location.reload();
                } else {
                    $('#' + '{{ modal_id }}' + ' .modal-content').html(data)
                    $('#' + '{{ modal_id }}' + ' .modal-content input[data-role=tagsinput], select[multiple][data-role=tagsinput]').tagsinput();
                }
            });
        });
    });
});
{% endmacro %}

{% macro opp_table(opps) %}
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th scope="col">id</th>
                <th scope="col">Supplier</th>
                <th scope="col">Market</th>
                <th scope="col">Sale Price</th>
                <th scope="col">COGS</th>
                <th scope="col">Profit</th>
                <th scope="col">Margin</th>
                <th scope="col">ROI</th>
            </tr>
        </thead>
        <tbody>
            {% for opp in opps %}
            <tr>
                <td><b>{{ opp.id }}</b></td>
                <td>
                    <b><a href="{{ url_for('product_details', product_id=opp.supply_id) }}">{{ opp.supply.title }}</a></b> <a target="_blank" href="{{ opp.supply.detail_url }}"><i class="fa fa-external-link"></i></a><br>
                    {{ opp.supply.vendor.name }} {{ opp.supply.sku }}, {{ as_money(opp.supply.price) }} / {{ opp.supply.quantity }}<br>
                    Shipping: {{ as_percent(opp.supply.vendor.ship_rate) }}
                </td>
                <td>
                    <b><a href="{{ url_for('product_details', product_id=opp.market_id) }}">{{ opp.market.title }}</a></b> <a target="_blank" href="{{ opp.market.detail_url }}"><i class="fa fa-external-link"></i></a><br>
                    {{ opp.market.vendor.name }} {{ opp.market.sku }}, {{ as_money(opp.market.price) }} / {{ opp.market.quantity }}<br>
                    Market fees: {{ as_money(opp.market.market_fees) }}
                </td>
                <td>{{ as_money(opp.market.price) }}</td>
                <td>{{ as_money(opp.cogs) }}</td>
                <td>{{ as_money(opp.profit) }}</td>
                <td>{{ as_percent(opp.margin) }}</td>
                <td>{{ as_percent(opp.roi) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endmacro %}